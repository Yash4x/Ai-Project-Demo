{% extends "base.html" %}

{% block title %}Generate Single Image - AI ImageGen{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header -->
    <div class="text-center mb-12">
        <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
            <i class="fas fa-image text-blue-500 mr-4"></i>
            Create Single Image
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Transform your ideas into stunning visuals with AI. Describe what you want and watch it come to life.
        </p>
    </div>

    <!-- Generation Form -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-gray-100">
        <form id="imageForm" class="space-y-6">
            <!-- Prompt Input -->
            <div>
                <label for="prompt" class="block text-lg font-semibold text-gray-900 mb-3">
                    <i class="fas fa-pen text-blue-500 mr-2"></i>
                    Image Description
                </label>
                <textarea 
                    id="prompt" 
                    name="prompt" 
                    rows="4" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-gray-900 placeholder-gray-500"
                    placeholder="Describe the image you want to create... Be creative and detailed! For example: 'A majestic dragon soaring through a starlit sky above a medieval castle, digital art style'"
                    required
                ></textarea>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    Tip: Be specific about style, colors, mood, and details for best results
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label for="size" class="block text-sm font-medium text-gray-700 mb-2">Image Size</label>
                    <select id="size" name="size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="1024x1024">Square (1024×1024)</option>
                        <option value="1024x1792">Portrait (1024×1792)</option>
                        <option value="1792x1024">Landscape (1792×1024)</option>
                    </select>
                </div>
                <div>
                    <label for="quality" class="block text-sm font-medium text-gray-700 mb-2">Quality</label>
                    <select id="quality" name="quality" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="standard">Standard</option>
                        <option value="hd">HD (Higher Cost)</option>
                    </select>
                </div>
                <div>
                    <label for="style" class="block text-sm font-medium text-gray-700 mb-2">Style</label>
                    <select id="style" name="style" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="vivid">Vivid (Colorful)</option>
                        <option value="natural">Natural (Realistic)</option>
                    </select>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="text-center">
                <button type="submit" id="generateBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-8 rounded-xl text-lg transform hover:scale-105 transition-all duration-200 shadow-lg">
                    <i class="fas fa-magic mr-3"></i>
                    Generate Image
                </button>
            </div>
        </form>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                <h3 class="text-2xl font-semibold text-gray-900 mb-2">Creating your image...</h3>
                <p class="text-gray-600 mb-4">This may take 10-30 seconds</p>
                <div class="w-full max-w-md bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full animate-pulse" style="width: 100%"></div>
                </div>
                <p id="loadingText" class="text-sm text-gray-500 mt-3">Processing your creative vision...</p>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-green-500 text-white p-6">
                <h3 class="text-2xl font-semibold flex items-center">
                    <i class="fas fa-check-circle mr-3"></i>
                    Image Generated Successfully!
                </h3>
            </div>
            <div class="p-8">
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Image Display -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <img id="generatedImage" class="w-full h-auto rounded-lg shadow-lg" alt="Generated Image">
                        </div>
                        <div class="flex gap-3">
                            <button id="downloadBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                            <button onclick="openImageInNewTab()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-external-link-alt mr-2"></i>Open
                            </button>
                        </div>
                    </div>
                    
                    <!-- Details Panel -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Original Prompt:</h4>
                            <p id="originalPrompt" class="text-gray-600 bg-gray-50 p-3 rounded-lg"></p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">AI Revised Prompt:</h4>
                            <p id="revisedPrompt" class="text-gray-600 bg-gray-50 p-3 rounded-lg text-sm"></p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" id="generationTime">0s</div>
                                <div class="text-sm text-gray-600">Generation Time</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600">✓</div>
                                <div class="text-sm text-gray-600">Auto-Saved</div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">File Location:</h4>
                            <code id="filePath" class="text-xs text-gray-600 bg-gray-100 p-2 rounded block break-all"></code>
                        </div>
                        
                        <button onclick="resetForm()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-redo mr-2"></i>Generate Another Image
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Section -->
    <div id="errorSection" class="hidden">
        <div class="bg-red-50 border border-red-200 rounded-2xl p-6">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3 mt-1"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Generation Failed</h3>
                    <p id="errorMessage" class="text-red-700"></p>
                    <button onclick="resetForm()" class="mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentImageUrl = '';

document.getElementById('imageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Get form data
    const formData = new FormData(this);
    const data = {
        prompt: formData.get('prompt'),
        size: formData.get('size'),
        quality: formData.get('quality'),
        style: formData.get('style')
    };
    
    // Show loading
    showLoading();
    
    try {
        const response = await fetch('/api/generate-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResults(result, data.prompt);
        } else {
            showError(result.error || 'Unknown error occurred');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Network error: ' + error.message);
    }
});

function showLoading() {
    document.getElementById('loadingIndicator').classList.remove('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('errorSection').classList.add('hidden');
    document.getElementById('generateBtn').disabled = true;
    
    // Animate loading text
    const loadingTexts = [
        'Processing your creative vision...',
        'AI is analyzing your prompt...',
        'Generating high-quality artwork...',
        'Adding final touches...'
    ];
    
    let textIndex = 0;
    const textInterval = setInterval(() => {
        if (textIndex < loadingTexts.length) {
            document.getElementById('loadingText').textContent = loadingTexts[textIndex];
            textIndex++;
        } else {
            clearInterval(textInterval);
        }
    }, 3000);
}

function showResults(result, originalPrompt) {
    document.getElementById('loadingIndicator').classList.add('hidden');
    document.getElementById('generateBtn').disabled = false;
    
    // Populate results
    const img = document.getElementById('generatedImage');
    img.src = result.web_path;
    currentImageUrl = result.web_path;
    
    document.getElementById('originalPrompt').textContent = originalPrompt;
    document.getElementById('revisedPrompt').textContent = result.revised_prompt || 'N/A';
    document.getElementById('generationTime').textContent = result.generation_time + 's';
    document.getElementById('filePath').textContent = result.file_path;
    
    // Set download link
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.onclick = () => downloadImage(result.web_path, 'generated-image.png');
    
    document.getElementById('resultsSection').classList.remove('hidden');
}

function showError(message) {
    document.getElementById('loadingIndicator').classList.add('hidden');
    document.getElementById('generateBtn').disabled = false;
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').classList.remove('hidden');
}

function resetForm() {
    document.getElementById('imageForm').reset();
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('errorSection').classList.add('hidden');
    document.getElementById('loadingIndicator').classList.add('hidden');
}

function downloadImage(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function openImageInNewTab() {
    if (currentImageUrl) {
        window.open(currentImageUrl, '_blank');
    }
}

// Add some visual feedback
document.getElementById('prompt').addEventListener('input', function() {
    const charCount = this.value.length;
    const color = charCount < 10 ? 'text-red-500' : charCount > 4000 ? 'text-red-500' : 'text-green-500';
    // You could add character count display here if needed
});
</script>
{% endblock %}